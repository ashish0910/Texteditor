<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
        <button id="save">save position</button>
        <button id="restore">restore position</button>
        <div id="bE" contenteditable=true>Click in the box to focus caret position then save button to save caret position, then click delete html, then click restore html and finally click restore position to see caret position restored</div>
<script>

function saveCaretPosition(context){
    var selection = window.getSelection();
    var range = selection.getRangeAt(0);
    range.setStart(  context, 0 );
    var len = range.toString().length;

    return function restore(){
        var pos = getTextNodeAtPosition(context, len);
        selection.removeAllRanges();
        var range = new Range();
        range.setStart(pos.node ,pos.position);
        selection.addRange(range);

    }
}

function getTextNodeAtPosition(root, index){
    var lastNode = null;

    var treeWalker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT,function next(node) {
        if(index >= node.textContent.length){
            index -= node.textContent.length;
            lastNode = node;
            return NodeFilter.FILTER_REJECT
        }
        return NodeFilter.FILTER_ACCEPT;
    });
    var c = treeWalker.nextNode();
    return {
        node: c? c: root,
        position: c? index:  0
    };
}

var code = document.getElementById("bE");
var restore ;

document.getElementById("save").addEventListener("click",function(){
  restore = saveCaretPosition(document.getElementById("bE"));
});

document.getElementById("restore").addEventListener("click",function(){
  restore();
})

// code.addEventListener('input',function (e) {
//   var restore = saveCaretPosition(this);
//   Prism.highlightElement(this);
//   restore();
// })

</script>
</body>
</html>